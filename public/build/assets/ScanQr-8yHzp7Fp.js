import{d as j,r as u,g as M,y as A,N as I,c as h,a as m,u as w,h as Q,w as T,b as t,t as p,k as U,o as y,j as E,v as N,F as P,s as V}from"./app-hprv82iD.js";import{B as q}from"./BrowserQRCodeReader-lwVMlZcW.js";import{S as $,_ as z}from"./AppLayout.vue_vue_type_script_setup_true_lang-Vvll4woM.js";import{C as H}from"./camera-Bzj9lo5g.js";import"./lazy-CSzc0j1S.js";const L={class:"flex flex-1 flex-col gap-6 p-6"},O={class:"rounded-3xl border border-sidebar-border/60 bg-background p-6"},W={class:"flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between"},G={class:"flex items-center gap-2 rounded-full border border-sidebar-border/70 px-4 py-2 text-sm font-semibold text-muted-foreground"},J={class:"grid gap-6 lg:grid-cols-[1.4fr_0.9fr]"},K={class:"rounded-3xl border border-sidebar-border/60 bg-background p-6"},X={class:"flex items-center justify-between"},Y={class:"relative mt-4 overflow-hidden rounded-2xl border border-dashed border-sidebar-border/70 bg-muted/20"},Z={class:"aspect-video w-full bg-black/80"},ee={key:0,class:"absolute inset-0 flex flex-col items-center justify-center gap-2 bg-black/60 p-6 text-center text-sm text-white"},te={class:"rounded-3xl border border-sidebar-border/60 bg-background p-6"},oe={class:"mt-4 space-y-3"},ae=["disabled"],re={key:0,class:"text-sm text-red-500"},ue=j({__name:"ScanQr",setup(se){const n=u(null),r=u(!1),l=u(""),v=u(""),s=u(!1),R=M(()=>typeof window<"u"&&"BarcodeDetector"in window);let b=null,f=null,i=null,d=0,_=0;const S=M(()=>v.value.trim().toUpperCase()),F=[{facingMode:"environment"},{facingMode:{ideal:"environment"}},{facingMode:"user"},!0];async function B(){if(typeof navigator>"u"||!navigator.mediaDevices?.getUserMedia){const o=typeof location<"u"&&location.protocol==="http:"?" Open this page using https:// or http://localhost or http://127.0.0.1 (same port if needed).":"";throw new Error("Camera is only allowed on secure pages (HTTPS or localhost)."+o)}for(const o of F)try{return await navigator.mediaDevices.getUserMedia({video:o,audio:!1})}catch{continue}return navigator.mediaDevices.getUserMedia({video:!0,audio:!1})}function c(){r.value=!1,d&&(cancelAnimationFrame(d),d=0),f&&(f.stop(),f=null),i&&(i.getTracks().forEach(o=>o.stop()),i=null)}async function g(o){if(!(!o||s.value)){s.value=!0,l.value="";try{const e=await fetch(`/scan/lookup/${encodeURIComponent(o)}`,{headers:{Accept:"application/json"}}),a=await e.json();if(!e.ok||!a.redirect){l.value=a.message||"Unable to locate a record for this QR code.";return}V.visit(a.redirect)}catch(e){l.value="We could not reach the server. Please try again.",console.error(e)}finally{s.value=!1}}}async function x(){if(!b||!n.value||!r.value||s.value)return;const o=performance.now();if(o-_<400){d=requestAnimationFrame(x);return}_=o;try{const e=await b.detect(n.value);if(e.length){const a=e[0]?.rawValue?.trim().toUpperCase();if(a){c(),await g(a);return}}}catch(e){console.error(e)}d=requestAnimationFrame(x)}async function k(){if(!(r.value||s.value)&&n.value){l.value="";try{if(i=await B(),n.value.srcObject=i,await n.value.play(),R.value)b=new window.BarcodeDetector({formats:["qr_code"]}),r.value=!0,d=requestAnimationFrame(x);else{const o=new q(void 0,{delayBetweenScanAttempts:200});r.value=!0,f=await o.decodeFromStream(i,n.value,(e,a)=>{if(!(!r.value||s.value)){if(e){const C=e.getText()?.trim().toUpperCase();C&&(c(),g(C));return}a&&a.name!=="NotFoundException"&&console.error(a)}})}}catch(o){l.value=o instanceof Error&&o.message?o.message:"Camera access was blocked or unavailable. Please allow camera permissions and try again.",console.error(o),c()}}}function D(){g(S.value)}return A(()=>{k()}),I(()=>{c()}),(o,e)=>(y(),h(P,null,[m(w(Q),{title:"Scan QR Code"}),m(z,null,{default:T(()=>[t("div",L,[t("section",O,[t("div",W,[e[2]||(e[2]=t("div",{class:"space-y-2"},[t("p",{class:"text-xs uppercase tracking-[0.3em] text-muted-foreground"}," Scanner "),t("h1",{class:"text-2xl font-semibold"},"QR Code Scanner"),t("p",{class:"text-sm text-muted-foreground"}," Scan MIS asset QR codes to retrieve inventory records instantly. ")],-1)),t("div",G,[m(w($),{class:"h-4 w-4"}),t("span",null,p(r.value?"Scanning live":"Scanner idle"),1)])])]),t("section",J,[t("div",K,[t("div",X,[e[3]||(e[3]=t("h2",{class:"text-base font-semibold"},"Live camera feed",-1)),t("button",{type:"button",class:"rounded-full border border-sidebar-border/70 px-4 py-2 text-xs font-semibold text-muted-foreground transition-colors hover:bg-muted/40",onClick:e[0]||(e[0]=a=>r.value?c():k())},p(r.value?"Pause":"Start"),1)]),t("div",Y,[t("div",Z,[t("video",{ref_key:"videoRef",ref:n,class:"h-full w-full object-cover",muted:"",playsinline:""},null,512)]),r.value?U("",!0):(y(),h("div",ee,[m(w(H),{class:"h-6 w-6"}),e[4]||(e[4]=t("p",null,"Tap start to activate the scanner.",-1))]))]),e[5]||(e[5]=t("p",{class:"mt-4 text-xs text-muted-foreground"}," Align the QR code within the frame. The scanner will automatically load the linked record. ",-1))]),t("div",te,[e[6]||(e[6]=t("h2",{class:"text-base font-semibold"},"Manual lookup",-1)),e[7]||(e[7]=t("p",{class:"mt-2 text-sm text-muted-foreground"}," If the camera cannot scan, enter the MIS UID manually. ",-1)),t("div",oe,[E(t("input",{"onUpdate:modelValue":e[1]||(e[1]=a=>v.value=a),type:"text",placeholder:"MIS-UID-00001",class:"w-full rounded-xl border border-sidebar-border/70 bg-background px-3 py-2 text-sm"},null,512),[[N,v.value]]),t("button",{type:"button",class:"w-full rounded-xl bg-[#2563eb] px-4 py-2.5 text-sm font-semibold text-white transition-colors hover:bg-[#1d4ed8] disabled:cursor-not-allowed disabled:opacity-60",disabled:!S.value||s.value,onClick:D},p(s.value?"Searching...":"Find record"),9,ae),l.value?(y(),h("p",re,p(l.value),1)):U("",!0)]),e[8]||(e[8]=t("div",{class:"mt-6 rounded-xl bg-muted/40 px-4 py-3 text-xs text-muted-foreground"},[t("p",{class:"font-semibold text-foreground"},"Tips"),t("p",{class:"mt-2"}," Use the official MIS labels generated by the QR tool to ensure accurate results. ")],-1))])])])]),_:1})],64))}});export{ue as default};
